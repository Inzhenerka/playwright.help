---
id: test-snapshots
title: "Визуальные сравнения"
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import HTMLCard from '@site/src/components/HTMLCard';

## Введение

Playwright Test включает возможность создания и визуального сравнения скриншотов с помощью `await expect(page).toHaveScreenshot()`. При первом выполнении Playwright Test сгенерирует эталонные скриншоты. Последующие запуски будут сравнивать с эталоном.

```js title="example.spec.ts"
import { test, expect } from '@playwright/test';

test('пример теста', async ({ page }) => {
  await page.goto('https://playwright.dev');
  await expect(page).toHaveScreenshot();
});
```

:::warning
Отображение в браузере может варьироваться в зависимости от операционной системы, версии, настроек, аппаратного обеспечения, источника питания (батарея или адаптер питания), режима безголовости и других факторов. Для получения последовательных скриншотов запускайте тесты в той же среде, где были сгенерированы базовые скриншоты.
:::

## Генерация скриншотов

Когда вы запустите вышеуказанный код в первый раз, тестовый раннер сообщит:

```txt
Ошибка: Снимок не существует по адресу example.spec.ts-snapshots/example-test-1-chromium-darwin.png, записываю фактический.
```

Это происходит потому, что золотого файла еще не было. Этот метод сделал несколько скриншотов, пока два последовательных скриншота не совпали, и сохранил последний скриншот в файловую систему. Теперь он готов к добавлению в репозиторий.

Имя папки с золотыми ожиданиями начинается с имени вашего тестового файла:

```bash
drwxr-xr-x  5 user  group  160 Jun  4 11:46 .
drwxr-xr-x  6 user  group  192 Jun  4 11:45 ..
-rw-r--r--  1 user  group  231 Jun  4 11:16 example.spec.ts
drwxr-xr-x  3 user  group   96 Jun  4 11:46 example.spec.ts-snapshots
```

Имя снимка `example-test-1-chromium-darwin.png` состоит из нескольких частей:
- `example-test-1.png` - автоматически сгенерированное имя снимка. В качестве альтернативы вы можете указать имя снимка в качестве первого аргумента метода `toHaveScreenshot()`:
  
  ```js
  await expect(page).toHaveScreenshot('landing.png');
  ```
  
- `chromium-darwin` - имя браузера и платформа. Скриншоты различаются между браузерами и платформами из-за различного рендеринга, шрифтов и других факторов, поэтому вам понадобятся разные снимки для них. Если вы используете несколько проектов в вашем [файле конфигурации](./test-configuration.mdx), имя проекта будет использоваться вместо `chromium`.

Имя и путь к снимку можно настроить с помощью [testConfig.snapshotPathTemplate](/api/class-testconfig.mdx#test-config-snapshot-path-template) в конфигурации playwright.

## Обновление скриншотов

Иногда вам нужно обновить эталонный скриншот, например, когда страница изменилась. Сделайте это с помощью флага `--update-snapshots`.

```bash
npx playwright test --update-snapshots
```

> Обратите внимание, что `snapshotName` также принимает массив сегментов пути к файлу снимка, например `expect().toHaveScreenshot(['relative', 'path', 'to', 'snapshot.png'])`.
> Однако этот путь должен оставаться в директории снимков для каждого тестового файла (т.е. `a.spec.js-snapshots`), иначе будет выброшено исключение.

## Опции

### maxDiffPixels

Playwright Test использует библиотеку [pixelmatch](https://github.com/mapbox/pixelmatch). Вы можете [передать различные параметры](./api/class-pageassertions.mdx#page-assertions-to-have-screenshot-1) для изменения ее поведения:

```js title="example.spec.ts"
import { test, expect } from '@playwright/test';

test('пример теста', async ({ page }) => {
  await page.goto('https://playwright.dev');
  await expect(page).toHaveScreenshot({ maxDiffPixels: 100 });
});
```

Если вы хотите использовать значение по умолчанию для всех тестов в проекте, вы можете указать его в конфигурации playwright, либо глобально, либо для каждого проекта:

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';
export default defineConfig({
  expect: {
    toHaveScreenshot: { maxDiffPixels: 100 },
  },
});
```

### stylePath

Вы можете применить пользовательский стиль к вашей странице во время создания скриншота. Это позволяет фильтровать динамические или изменчивые элементы, тем самым улучшая детерминированность скриншота.

```css title="screenshot.css"
iframe {
  visibility: hidden;
}
```

```js title="example.spec.ts"
import { test, expect } from '@playwright/test';

test('пример теста', async ({ page }) => {
  await page.goto('https://playwright.dev');
  await expect(page).toHaveScreenshot({ stylePath: path.join(__dirname, 'screenshot.css') });
});
```

Если вы хотите использовать значение по умолчанию для всех тестов в проекте, вы можете указать его в конфигурации playwright, либо глобально, либо для каждого проекта:

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';
export default defineConfig({
  expect: {
    toHaveScreenshot: {
      stylePath: './screenshot.css'
    },
  },
});
```

## Ненадежные снимки

Помимо скриншотов, вы можете использовать `expect(value).toMatchSnapshot(snapshotName)` для сравнения текста или произвольных двоичных данных. Playwright Test автоматически определяет тип содержимого и использует соответствующий алгоритм сравнения.

Здесь мы сравниваем текстовое содержимое с эталоном.

```js title="example.spec.ts"
import { test, expect } from '@playwright/test';

test('пример теста', async ({ page }) => {
  await page.goto('https://playwright.dev');
  expect(await page.textContent('.hero__title')).toMatchSnapshot('hero.txt');
});
```

Снимки хранятся рядом с тестовым файлом в отдельной директории. Например, файл `my.spec.ts` создаст и сохранит снимки в директории `my.spec.ts-snapshots`. Вы должны закоммитить эту директорию в вашу систему контроля версий (например, `git`) и просмотреть любые изменения в ней.