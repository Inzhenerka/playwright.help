---
id: test-global-setup-teardown
title: "Глобальная настройка и завершение"
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import HTMLCard from '@site/src/components/HTMLCard';

## Введение

Существует два способа настройки глобальной настройки и завершения: с использованием глобального файла настройки и его указанием в конфигурации под [`globalSetup`](#option-2-configure-globalsetup-and-globalteardown) или с использованием [зависимостей проекта](#option-1-project-dependencies). При использовании зависимостей проекта вы определяете проект, который выполняется перед всеми другими проектами. Это рекомендуемый способ настройки глобальной настройки, так как с зависимостями проекта ваш HTML-отчет будет показывать глобальную настройку, просмотрщик трасс будет записывать трассу настройки, и можно будет использовать фикстуры.

## Вариант 1: Зависимости проекта

[Зависимости проекта](./api/class-testproject#test-project-dependencies) — это список проектов, которые должны выполняться перед запуском тестов в другом проекте. Они могут быть полезны для настройки действий глобальной настройки, чтобы один проект зависел от выполнения этого проекта первым. Использование зависимостей позволяет глобальной настройке производить трассы и другие артефакты.

### Настройка

Сначала мы добавляем новый проект с именем 'setup db'. Затем мы задаем ему свойство [testProject.testMatch](/api/class-testproject.mdx#test-project-test-match), чтобы сопоставить файл с именем `global.setup.ts`:

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  // ...
  projects: [
    {
      name: 'setup db',
      testMatch: /global\.setup\.ts/,
    },
    // {
    //   другой проект
    // }
  ]
});
```

Затем мы добавляем свойство [testProject.dependencies](/api/class-testproject.mdx#test-project-dependencies) к нашим проектам, которые зависят от проекта настройки, и передаем в массив имя нашего зависимого проекта, которое мы определили на предыдущем шаге:

```js title="playwright.config.ts"
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  // ...
  projects: [
    {
      name: 'setup db',
      testMatch: /global\.setup\.ts/,
    },
    {
      name: 'chromium with db',
      use: { ...devices['Desktop Chrome'] },
      dependencies: ['setup db'],
    },
  ]
});
```

В этом примере проект 'chromium with db' зависит от проекта 'setup db'. Затем мы создаем тест настройки, который хранится на корневом уровне вашего проекта (обратите внимание, что код настройки и завершения должен быть определен как обычные тесты, вызывая функцию [test()](./api/class-test#test-call)):

```js title="tests/global.setup.ts"
import { test as setup } from '@playwright/test';

setup('create new database', async ({ }) => {
  console.log('создание новой базы данных...');
  // Инициализация базы данных
});
```

```js title="tests/menu.spec.ts"
import { test, expect } from '@playwright/test';

test('menu', async ({ page }) => {
  // Ваш тест, который зависит от базы данных
});
```

### Завершение

Вы можете завершить вашу настройку, добавив свойство [testProject.teardown](/api/class-testproject.mdx#test-project-teardown) к вашему проекту настройки. Это будет выполнено после того, как все зависимые проекты будут выполнены.

Сначала мы добавляем свойство [testProject.teardown](/api/class-testproject.mdx#test-project-teardown) к нашему проекту настройки с именем 'cleanup db', которое мы дали нашему проекту завершения на предыдущем шаге:

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  // ...
  projects: [
    {
      name: 'setup db',
      testMatch: /global\.setup\.ts/,
      teardown: 'cleanup db',
    },
    {
      name: 'cleanup db',
      testMatch: /global\.teardown\.ts/,
    },
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
      dependencies: ['setup db'],
    },
  ]
});
```

Затем мы создаем файл `global.teardown.ts` в каталоге tests вашего проекта. Этот файл будет использоваться для удаления данных из базы данных после выполнения всех тестов.

```js title="tests/global.teardown.ts"
import { test as teardown } from '@playwright/test';

teardown('delete database', async ({ }) => {
  console.log('удаление тестовой базы данных...');
  // Удаление базы данных
});
```

### Больше примеров

Для более подробных примеров ознакомьтесь с:
- нашим [руководством по аутентификации](./auth.mdx)
- нашей статьей в блоге [Лучшая глобальная настройка в Playwright с повторным использованием входа с зависимостями проекта](https://dev.to/playwright/a-better-global-setup-in-playwright-reusing-login-with-project-dependencies-14)
- [видео о релизе v1.31](https://youtu.be/PI50YAPTAs4), чтобы увидеть демонстрацию

## Вариант 2: Настройка globalSetup и globalTeardown

Вы можете использовать опцию `globalSetup` в [файле конфигурации](./test-configuration.mdx#advanced-configuration), чтобы настроить что-то один раз перед запуском всех тестов. Глобальный файл настройки должен экспортировать одну функцию, которая принимает объект конфигурации. Эта функция будет выполнена один раз перед всеми тестами.

Аналогично, используйте `globalTeardown`, чтобы выполнить что-то один раз после всех тестов. В качестве альтернативы, позвольте `globalSetup` вернуть функцию, которая будет использоваться в качестве глобального завершения. Вы можете передавать данные, такие как номер порта, токены аутентификации и т. д., из вашей глобальной настройки в ваши тесты с помощью переменных окружения.

:::note

Обратите внимание на предостережения по поводу `globalSetup` и `globalTeardown`:
- Эти методы не будут производить трассы или артефакты, если это не будет явно включено, как описано в [Запись трассы ошибок во время глобальной настройки](#capturing-trace-of-failures-during-global-setup).
- Опции, такие как `headless` или `testIdAttribute`, указанные в файле конфигурации, не применяются,
- Необработанное исключение, выброшенное в `globalSetup`, предотвратит выполнение тестов Playwright, и результаты тестов не появятся в отчетах.

Рекомендуется использовать [зависимости проекта](#option-1-project-dependencies), чтобы производить трассы, артефакты, учитывать параметры конфигурации и получать результаты тестов в отчетах даже в случае сбоя настройки.
:::

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  globalSetup: require.resolve('./global-setup'),
  globalTeardown: require.resolve('./global-teardown'),
});
```

### Пример

Вот пример глобальной настройки, которая аутентифицирует один раз и повторно использует состояние аутентификации в тестах. Он использует параметры `baseURL` и `storageState` из файла конфигурации.

```js title="global-setup.ts"
import { chromium, type FullConfig } from '@playwright/test';

async function globalSetup(config: FullConfig) {
  const { baseURL, storageState } = config.projects[0].use;
  const browser = await chromium.launch();
  const page = await browser.newPage();
  await page.goto(baseURL!);
  await page.getByLabel('User Name').fill('user');
  await page.getByLabel('Password').fill('password');
  await page.getByText('Sign in').click();
  await page.context().storageState({ path: storageState as string });
  await browser.close();
}

export default globalSetup;
```

Укажите `globalSetup`, `baseURL` и `storageState` в файле конфигурации.

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';
export default defineConfig({
  globalSetup: require.resolve('./global-setup'),
  use: {
    baseURL: 'http://localhost:3000/',
    storageState: 'state.json',
  },
});
```

Тесты уже начинают с аутентификацией, потому что мы указываем `storageState`, который был заполнен глобальной настройкой.

```js
import { test } from '@playwright/test';

test('test', async ({ page }) => {
  await page.goto('/');
  // Вы вошли в систему!
});
```

Вы можете сделать произвольные данные доступными в ваших тестах из вашего файла глобальной настройки, установив их как переменные окружения через `process.env`.

```js title="global-setup.ts"
import type { FullConfig } from '@playwright/test';

async function globalSetup(config: FullConfig) {
  process.env.FOO = 'некоторые данные';
  // Или более сложная структура данных в формате JSON:
  process.env.BAR = JSON.stringify({ some: 'data' });
}

export default globalSetup;
```

Тесты имеют доступ к свойствам `process.env`, установленным в глобальной настройке.

```js
import { test } from '@playwright/test';

test('test', async ({ page }) => {
  // переменные окружения, которые установлены в globalSetup, доступны только внутри test().
  const { FOO, BAR } = process.env;

  // Свойства FOO и BAR заполнены.
  expect(FOO).toEqual('некоторые данные');

  const complexData = JSON.parse(BAR);
  expect(BAR).toEqual({ some: 'data' });
});
```

### Запись трассы ошибок во время глобальной настройки

В некоторых случаях может быть полезно записать трассу ошибок, возникших во время глобальной настройки. Для этого вы должны [начать трассировку](./api/class-tracing.mdx#tracing-start) в вашей настройке и убедиться, что вы [остановили трассировку](./api/class-tracing.mdx#tracing-stop), если произошла ошибка, прежде чем эта ошибка будет выброшена. Это можно сделать, обернув вашу настройку в блок `try...catch`. Вот пример, который расширяет пример глобальной настройки для захвата трассы.

```js title="global-setup.ts"
import { chromium, type FullConfig } from '@playwright/test';

async function globalSetup(config: FullConfig) {
  const { baseURL, storageState } = config.projects[0].use;
  const browser = await chromium.launch();
  const context = await browser.newContext();
  const page = await context.newPage();
  try {
    await context.tracing.start({ screenshots: true, snapshots: true });
    await page.goto(baseURL!);
    await page.getByLabel('User Name').fill('user');
    await page.getByLabel('Password').fill('password');
    await page.getByText('Sign in').click();
    await context.storageState({ path: storageState as string });
    await context.tracing.stop({
      path: './test-results/setup-trace.zip',
    });
    await browser.close();
  } catch (error) {
    await context.tracing.stop({
      path: './test-results/failed-setup-trace.zip',
    });
    await browser.close();
    throw error;
  }
}

export default globalSetup;
```