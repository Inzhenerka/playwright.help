---
id: test-sharding
title: "Шардинг"
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import HTMLCard from '@site/src/components/HTMLCard';

## Введение

По умолчанию Playwright выполняет тестовые файлы в [параллельном режиме](./test-parallel.mdx) и стремится к оптимальному использованию ядер ЦП на вашем компьютере. Чтобы достичь еще большей параллелизации, вы можете дополнительно масштабировать выполнение тестов Playwright, запуская тесты на нескольких машинах одновременно. Мы называем этот режим работы "шардингом". Шардинг в Playwright означает разделение ваших тестов на более мелкие части, называемые "шардами". Каждый шард — это отдельная задача, которая может выполняться независимо. Основная цель — разделить ваши тесты, чтобы ускорить время их выполнения.

Когда вы шардите свои тесты, каждый шард может выполняться самостоятельно, используя доступные ядра ЦП. Это помогает ускорить процесс тестирования, выполняя задачи одновременно.

В CI-пайплайне каждый шард может выполняться как отдельная задача, используя аппаратные ресурсы, доступные в вашем CI-пайплайне, такие как ядра ЦП, для более быстрого выполнения тестов.

## Шардинг тестов между несколькими машинами

Чтобы разделить тестовый набор, передайте `--shard=x/y` в командной строке. Например, чтобы разделить набор на четыре шара, каждый из которых выполняет одну четверть тестов:

```bash
npx playwright test --shard=1/4
npx playwright test --shard=2/4
npx playwright test --shard=3/4
npx playwright test --shard=4/4
```

Теперь, если вы запустите эти шарды параллельно на разных задачах, ваш тестовый набор завершится в четыре раза быстрее.

Обратите внимание, что Playwright может шардинговать только те тесты, которые могут выполняться параллельно. По умолчанию это означает, что Playwright будет шардинговать тестовые файлы. Узнайте о других вариантах в [руководстве по параллелизму](./test-parallel.mdx).

## Балансировка шардов

Шардинг может выполняться на двух уровнях детализации в зависимости от того, используете ли вы опцию [testProject.fullyParallel](/api/class-testproject.mdx#test-project-fully-parallel) или нет. Это влияет на то, как тесты распределяются по шартам.

**Шардинг с fullyParallel**

Когда `fullyParallel: true` включен, Playwright Test выполняет отдельные тесты параллельно на нескольких шарах, обеспечивая равномерное распределение тестов между шарами. Это позволяет достичь детализации на уровне тестов, что означает, что каждый шард будет пытаться сбалансировать количество отдельных тестов, которые он выполняет. Это предпочтительный режим для обеспечения равномерного распределения нагрузки при шардинге, так как Playwright может оптимизировать выполнение шардов на основе общего количества тестов.

**Шардинг без fullyParallel**

Без настройки fullyParallel Playwright Test по умолчанию использует детализацию на уровне файлов, что означает, что целые тестовые файлы назначаются шартам (обратите внимание, что один и тот же файл может быть назначен разным шарам в разных проектах). В этом случае количество тестов на файл может значительно повлиять на распределение шардов. Если ваши тестовые файлы не одинакового размера (т.е. некоторые файлы содержат значительно больше тестов, чем другие), определенные шарды могут в итоге выполнять значительно больше тестов, в то время как другие могут выполнять меньше или даже не выполнять их вовсе.

**Основные выводы:**
- **С** `fullyParallel: true`: Тесты разделяются на уровне отдельных тестов, что приводит к более сбалансированному выполнению шардов.
- **Без** `fullyParallel`: Тесты разделяются на уровне файлов, поэтому для балансировки шардов важно, чтобы ваши тестовые файлы были небольшими и одинакового размера.
- Чтобы обеспечить наиболее эффективное использование шардинга, особенно в CI-средах, рекомендуется использовать `fullyParallel: true`, когда вы стремитесь к сбалансированному распределению между шарами. В противном случае вам может потребоваться вручную организовать ваши тестовые файлы, чтобы избежать дисбаланса.

## Объединение отчетов из нескольких шардов

В предыдущем примере каждый тестовый шард имеет свой собственный отчет о тестах. Если вы хотите получить объединенный отчет, показывающий все результаты тестов из всех шардов, вы можете их объединить.

Начните с добавления репортера `blob` в конфигурацию при запуске в CI:

```ts title="playwright.config.ts"
export default defineConfig({
  testDir: './tests',
  reporter: process.env.CI ? 'blob' : 'html',
});
```

Blob-отчет содержит информацию обо всех тестах, которые были выполнены, и их результатах, а также все вложения тестов, такие как трассировки и различия скриншотов. Blob-отчеты могут быть объединены и преобразованы в любой другой отчет Playwright. По умолчанию blob-отчет будет сгенерирован в директории `blob-report`.

Чтобы объединить отчеты из нескольких шардов, поместите файлы blob-отчетов в одну директорию, например `all-blob-reports`. Имена blob-отчетов содержат номер шара, поэтому они не будут конфликтовать.

После этого выполните команду `npx playwright merge-reports`:

```bash
npx playwright merge-reports --reporter html ./all-blob-reports
```

Это создаст стандартный HTML-отчет в директории `playwright-report`.

## Пример GitHub Actions

GitHub Actions поддерживает [шардинг тестов между несколькими задачами](https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs) с использованием опции [`jobs.<job_id>.strategy.matrix`](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix). Опция `matrix` запустит отдельную задачу для каждой возможной комбинации предоставленных опций.

Следующий пример показывает, как настроить задачу для выполнения ваших тестов на четырех машинах параллельно, а затем объединить отчеты в один отчет. Не забудьте добавить `reporter: process.env.CI ? 'blob' : 'html',` в ваш файл `playwright.config.ts`, как в примере выше.
1. Сначала мы добавляем опцию `matrix` в конфигурацию нашей задачи с опцией `shardTotal: [4]`, содержащей общее количество шардов, которые мы хотим создать, и `shardIndex: [1, 2, 3, 4]` с массивом номеров шардов.
1. Затем мы запускаем наши тесты Playwright с опцией `--shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}`. Это запустит нашу команду тестирования для каждого шара.
1. Наконец, мы загружаем наш blob-отчет в артефакты GitHub Actions. Это сделает blob-отчет доступным для других задач в рабочем процессе.

```yaml title=".github/workflows/playwright.yml"
name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  playwright-tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Установка зависимостей
      run: npm ci
    - name: Установка браузеров Playwright
      run: npx playwright install --with-deps

    - name: Запуск тестов Playwright
      run: npx playwright test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

    - name: Загрузка blob-отчета в артефакты GitHub Actions
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: blob-report-${{ matrix.shardIndex }}
        path: blob-report
        retention-days: 1
```

1. После завершения всех шардов вы можете запустить отдельную задачу, которая объединит отчеты и создаст объединенный [HTML-отчет](./test-reporters.mdx#html-reporter). Чтобы обеспечить порядок выполнения, мы делаем задачу `merge-reports` [зависимой](https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow#defining-prerequisite-jobs) от нашей шардированной задачи `playwright-tests`, добавив `needs: [playwright-tests]`.

```yaml title=".github/workflows/playwright.yml"
jobs:
...
  merge-reports:
    # Объединить отчеты после выполнения playwright-tests, даже если некоторые шары не прошли
    if: ${{ !cancelled() }}
    needs: [playwright-tests]

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Установка зависимостей
      run: npm ci

    - name: Загрузка blob-отчетов из артефактов GitHub Actions
      uses: actions/download-artifact@v4
      with:
        path: all-blob-reports
        pattern: blob-report-*
        merge-multiple: true

    - name: Объединение в HTML-отчет
      run: npx playwright merge-reports --reporter html ./all-blob-reports

    - name: Загрузка HTML-отчета
      uses: actions/upload-artifact@v4
      with:
        name: html-report--attempt-${{ github.run_attempt }}
        path: playwright-report
        retention-days: 14
```

Теперь вы можете увидеть, что отчеты были объединены, и объединенный HTML-отчет доступен на вкладке артефактов GitHub Actions.

<img width="875" alt="image" src="https://github.com/microsoft/playwright/assets/9798949/b69dac59-fc19-4b98-8f49-814b1c29ca02" />

## CLI для объединения отчетов

`npx playwright merge-reports path/to/blob-reports-dir` считывает все blob-отчеты из переданной директории и объединяет их в один отчет.

При объединении отчетов из разных ОС вам нужно будет предоставить явную конфигурацию объединения, чтобы уточнить, какая директория должна использоваться в качестве корня тестов.

Поддерживаемые опции:
- `--reporter reporter-to-use`
  
  Какой отчет следует создать. Может быть несколько репортеров, разделенных запятой.
  
  Пример:
  
  ```bash
  npx playwright merge-reports --reporter=html,github ./blob-reports
  ```
  
- `--config path/to/config/file`
  
  Указывает файл конфигурации Playwright с выходными репортерами. Используйте эту опцию, чтобы передать дополнительную конфигурацию выходному репортеру. Этот файл конфигурации может отличаться от того, который использовался при создании blob-отчетов.
  
  Пример:
  
  ```bash
  npx playwright merge-reports --config=merge.config.ts ./blob-reports
  ```
  
  ```ts title="merge.config.ts"
  export default {
    testDir: 'e2e',
    reporter: [['html', { open: 'never' }]],
  };
  ```